<?xml version="1.0" encoding="utf-8" standalone="no"?>
<!DOCTYPE html
  PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml"><head><meta xmlns="" http-equiv="Content-Type" content="text/html; charset=utf-8"/><title>제5장 C External Procedure 유틸리티</title><link rel="stylesheet" href="../stylesheet.css" type="text/css"/><meta name="generator" content="DocBook XSL Stylesheets V1.72.0"/><link rel="start" href="index.html" title="Tibero External Procedure 안내서"/><link rel="up" href="index.html" title="Tibero External Procedure 안내서"/><link rel="prev" href="sect_extproc_using.html" title="제4장 C External Procedure 사용"/><link rel="next" href="chapter_java_extproc.html" title="제6장 Java External Procedure"/></head><body><div xmlns="" class="navheader"><table width="100%" summary="Navigation header"><tr><td class="navbar-title" colspan="3" align="center">제5장 C External Procedure 유틸리티</td></tr><tr><td width="20%" align="left"><a accesskey="p" href="sect_extproc_using.html">이전</a> </td><td class="navbar-title" width="60%" align="center"> </td><td width="20%" align="right"> <a accesskey="n" href="chapter_java_extproc.html">다음</a></td></tr></table><hr/></div><div class="chapter" lang="ko"><div class="titlepage"><div><div><h2 class="title"><a id="chapter_extproc_util"/>제5장 C External Procedure 유틸리티</h2></div></div></div><div class="toc"><p><b>내용 목차</b></p><dl><dt><span class="section"><a href="chapter_extproc_util.html#d5e1037">5.1. 개요</a></span></dt><dt><span class="section"><a href="chapter_extproc_util.html#d5e1061">5.2. C External Procedure 유틸리티 사용</a></span></dt><dd><dl><dt><span class="section"><a href="chapter_extproc_util.html#d5e1070">5.2.1. 사용자 공유 라이브러리 함수를 작성할 때 유의 사항</a></span></dt><dt><span class="section"><a href="chapter_extproc_util.html#d5e1079">5.2.2. 사용자 공유 라이브러리 함수를 PSM으로 등록할 때 유의 사항</a></span></dt></dl></dd><dt><span class="section"><a href="chapter_extproc_util.html#d5e1093">5.3. C External Procedure 유틸리티</a></span></dt><dd><dl><dt><span class="section"><a href="chapter_extproc_util.html#sect_SQLExtProcAllocMemory">5.3.1. SQLExtProcAllocMemory 함수</a></span></dt><dt><span class="section"><a href="chapter_extproc_util.html#sect_SQLExtProcRaiseError">5.3.2. SQLExtProcRaiseError 함수</a></span></dt><dt><span class="section"><a href="chapter_extproc_util.html#sect_SQLExtProcRaiseErrorWithMsg">5.3.3. SQLExtProcRaiseErrorWithMsg 함수</a></span></dt></dl></dd></dl></div>
  

  <p>본 장에서는 사용자 공유 라이브러리 함수를 작성하는 데 유용한 C External Procedure 유틸리티를
  설명한다.</p>

  <div class="section" lang="ko"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="d5e1037"/>5.1. 개요</h2></div></div></div>
    

    <p/>

    <p>C External Procedure에서는 사용자가 공유 라이브러리 함수를 구현하는 데 도움이 되는 몇 가지 API를
    제공하고 있다. 이러한 API를 <span><strong class="guibutton">C External Procedure 유틸리티</strong></span>라고
    한다.<a id="d5e1042" class="indexterm"/></p>

    <p>C External Procedure 유틸리티에 포함된 함수는 다음과 같다.</p>

    <div class="itemizedlist"><ul type="disc" compact="compact"><li>
        <p><a href="chapter_extproc_util.html#sect_SQLExtProcAllocMemory" title="5.3.1. SQLExtProcAllocMemory 함수"><code class="function">SQLExtProcAllocMemory</code></a></p>
      </li><li>
        <p><a href="chapter_extproc_util.html#sect_SQLExtProcRaiseError" title="5.3.2. SQLExtProcRaiseError 함수"><code class="function">SQLExtProcRaiseError</code></a></p>
      </li><li>
        <p><a href="chapter_extproc_util.html#sect_SQLExtProcRaiseErrorWithMsg" title="5.3.3. SQLExtProcRaiseErrorWithMsg 함수"><code class="function">SQLExtProcRaiseErrorWithMsg</code></a></p>
      </li></ul></div>

    <p>이러한 함수를 사용하기 위해서는 <span>Tibero</span>에서 제공하는 ExtProcContext 구조체를 알아야 하며,
    사용자가 공유 라이브러리를 작성할 때와 PSM으로 등록할 때 특별한 처리가 필요하다.</p>

    <p/>
  </div>

  <div class="section" lang="ko"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="d5e1061"/>5.2. C External Procedure 유틸리티 사용</h2></div></div></div>
    

    <p>C External Procedure 유틸리티를 사용하려면 <span>tbEPA</span>
    프로세스에 이 유틸리티를 사용하겠다는 내용을 명시하고, 사용자 공유 라이브러리 또한 이 점을 감안하여 작성해야 한다.</p>

    <p><span>tbEPA</span> 프로세스에 이러한 정보를 전달하기 위해서는 해당 사용자 공유 라이브러리
    함수를 PSM으로 등록시킬 때 <span><strong class="guibutton">WITH CONTEXT</strong></span> 문법을 명시해야 하며, 사용자 공유
    라이브러리 함수의 첫 번째 파라미터는 무조건 <span><strong class="guibutton">ExtProcContext *</strong></span>로 해야 한다.
    ExtProcContext는 extproc.h 파일에 정의되어 있으며, <span>tbEPA</span>
    프로세스에서 해당 C External Procedure 유틸리티 내의 함수를 처리해주는 채널로 사용한다.</p>

    <div class="section" lang="ko"><div class="titlepage"><div><div><h3 class="title"><a id="d5e1070"/>5.2.1. 사용자 공유 라이브러리 함수를 작성할 때 유의 사항</h3></div></div></div>
      

      <p><span>Tibero</span>는 사용자 공유 라이브러리 함수를 작성할 때 C External
      Procedure 유틸리티를 사용하는 경우를 대비하여 $<span>TB_</span>HOME/client/include 디렉터리에 있는 extproc.h 파일을
      제공한다. 만약 사용자가 작성할 공유 라이브러리 함수가 C External Procedure 유틸리티 내의 함수를 사용할
      예정이라면 반드시 extproc.h 파일을 포함해야 한다.</p>

      <p>예를 들면 다음과 같다.</p>

      <pre class="programlisting"><span><strong class="guibutton">#include "extproc.h"</strong></span>

char * get_encrypted_string(<span><strong class="guibutton">ExtProcContext *epc</strong></span>, char *str)
{
    ...
}</pre>
    </div>

    <div class="section" lang="ko"><div class="titlepage"><div><div><h3 class="title"><a id="d5e1079"/>5.2.2. 사용자 공유 라이브러리 함수를 PSM으로 등록할 때 유의 사항</h3></div></div></div>
      

      <p><a href="chapter_extproc_create.html#sect_user_func_psm" title="3.2.3. 사용자 함수를 PSM에 대응">“3.2.3. 사용자 함수를 PSM에 대응”</a>을 보면 <span><strong class="guibutton">[WITH
      CONTEXT]</strong></span> 문법을 볼 수 있다. 이것이 바로 C External Procedure 유틸리티를 사용하고
      있음을 DBMS에 알려주는 것이고, 이렇게 생성된 PSM을 수행할 경우에는 해당 정보를 <span>tbEPA</span>
      프로세스에게 전달한다.</p>

      <p>그러면 <span>tbEPA</span> 프로세스는 해당 라이브러리를 로드하여 사용자 함수로 파라미터를 보낼 때
      첫 번째 파라미터로 ExtProcContext의 포인터를 전달한다.</p>

      <pre class="programlisting">CREATE OR REPLACE FUNCTION ext_get_enc_char (chr CHAR(10))
       RETURN CHAR
       AS LANGUAGE C
       LIBRARY extproc
       NAME "get_encrypted_string"
       WITH CONTEXT
       PARAMETERS(CONTEXT, chr string);</pre>

      <p>위의 예처럼 PARAMETERS 문법을 명시할 경우 반드시 첫 번째 파라미터는
      <span><strong class="guibutton">CONTEXT</strong></span>로 해야 한다.</p>

      <div class="caution" style="margin-left: 0in; margin-right: 0in;"><h3 class="title">주의</h3>
        <p><span><strong class="guibutton">WITH CONTEXT</strong></span> 문법만 명시하고 PARAMETERS 문법을 생략하는
        경우 첫 번째 파라미터는 CONTEXT가 되고, 두 번째 파라미터부터 해당 PSM 파라미터가 전달된다는 점에 주의해야
        한다.</p>
      </div>
    </div>
  </div>

  <div class="section" lang="ko"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="d5e1093"/>5.3. C External Procedure 유틸리티</h2></div></div></div>
    

    <p>본 절에서는 C External Procedure 유틸리티에서 제공하는 함수를 설명한다.</p>

    <div class="section" lang="ko"><div class="titlepage"><div><div><h3 class="title"><a id="sect_SQLExtProcAllocMemory"/>5.3.1. SQLExtProcAllocMemory 함수<a id="d5e1098" class="indexterm"/><a id="d5e1100" class="indexterm"/></h3></div></div></div>
      

      <p>사용자가 작성한 공유 라이브러리 함수에서 동적으로 메모리 할당이 필요한 경우가 있다. 일반적으로 malloc,
      calloc 등의 함수를 사용하여 런타임 시 메모리를 할당받을 수 있으나, 만약 이 값을 반환 값 등으로 사용할 경우 할당된
      메모리를 해제하는 시점이 애매한 경우가 발생한다.</p>

      <p>이러한 문제를 해결하기 위해 C External Procedure 유틸리티에서는
      <code class="function">SQLExtProcAllocMemory</code> 함수를 제공한다. 이 함수를 사용하면 사용자가
      메모리를 동적으로 할당할 수 있으며, 할당된 메모리를 별도로 해제할 필요가 없다. 할당된 메모리는 해당 함수가 실행된 이후에
      자동으로 해제된다.</p>

      <div class="literallayout"><p/></div>

      <p><code class="function">SQLExtProcAllocMemory </code>함수의 세부 내용은 다음과
      같다.</p>

      <div class="itemizedlist"><ul type="disc" compact="compact"><li>
          <p>문법</p>

          <pre class="programlisting">SQLPOINTER SQLExtProcAllocMemory(ExtProcContext *, size_t size);</pre>
        </li><li>
          <p>파라미터</p>

          <div class="informaltable">
            <table border="1"><colgroup><col width="150" align="left"/><col/></colgroup><thead><tr><th align="left">파라미터</th><th>설명</th></tr></thead><tbody><tr><td align="left">ExtProcContext *</td><td>ExtProcContext 구조체의 포인터이다.</td></tr><tr><td align="left">size</td><td>할당받을 메모리의 크기이다.</td></tr></tbody></table>
          </div>
        </li><li>
          <p>반환 값</p>

          <div class="informaltable">
            <table border="1"><colgroup><col width="150" align="left"/><col/></colgroup><thead><tr><th align="left">성공여부</th><th>설명</th></tr></thead><tbody><tr><td align="left">성공</td><td>동적으로 할당한 메모리의 시작 주소를 반환한다.</td></tr><tr><td align="left">실패</td><td>NULL을 반환한다.</td></tr></tbody></table>
          </div>
        </li><li>
          <p>예제</p>

          <pre class="programlisting">#include &lt;string.h&gt;
#include "extproc.h"
#include "sqlcli.h"

char * my_concat(ExtProcContext *epc, char *str1, char *str2)
{
    char *ret_str;
    uint size;

    size = strlen(str1) + strlen(str2) + 1;
    ret_str = (char *) SQLExtProcAllocMemory(epc, size);

    strcpy(ret_str, str1);
    strcat(ret_str, str2);

    return ret_str;
}</pre>
        </li></ul></div>
    </div>

    <div class="section" lang="ko"><div class="titlepage"><div><div><h3 class="title"><a id="sect_SQLExtProcRaiseError"/>5.3.2. SQLExtProcRaiseError 함수<a id="d5e1152" class="indexterm"/><a id="d5e1154" class="indexterm"/></h3></div></div></div>
      

      <p>사용자 공유 라이브러리 함수를 수행하는 중에 에러가 발생하거나 에러를 발생시켜야 하는 경우 그 반환 값을 이용하여
      PSM 내에서 에러 핸들링 과정을 구현할 수 있다. 단, 사용자가 원하는 로직을 구현하기 위해서는 사용자 공유 라이브러리 함수뿐만
      아니라 그 함수와 대응되는 PSM이 사용되는 모든 곳에 에러 핸들링 과정이 필요하다는 단점이 있다.</p>

      <p>C External Procedure 유틸리티에서는 사용자 공유 라이브러리 함수에서 직접 DBMS 에러를 발생시켜
      앞에서 언급한 단점을 해결할 수 있는 함수를 제공한다. 이 함수를 이용하면 사용자 공유 라이브러리 함수 내에서 DIVIDE BY
      ZERO, NUMBER EXCEEDS PRECISION 등의 에러를 발생시킬 수 있다. 이러한 기능을 수행하는 함수가 바로
      <code class="function">SQLExtProcRaiseError</code>이다. 이 함수는 <a href="sect_extproc_using.html#sect_callback_service" title="4.2. Callback Service">Callback Service</a>에서도 사용할 수
      있다.</p>

      <div class="literallayout"><p/></div>

      <p><code class="function">SQLExtProcRaiseError</code> 함수의 세부 내용은 다음과
      같다.</p>

      <div class="itemizedlist"><ul type="disc" compact="compact"><li>
          <p>문법</p>

          <pre class="programlisting">void SQLExtProcRaiseError(ExtProcContext *, int errcode);</pre>
        </li><li>
          <p>파라미터</p>

          <div class="informaltable">
            <table border="1"><colgroup><col width="150" align="left"/><col/></colgroup><thead><tr><th align="left">파라미터</th><th>설명</th></tr></thead><tbody><tr><td align="left">ExtProcContext *</td><td>ExtProcContext 구조체의 포인터이다.</td></tr><tr><td align="left">errcode</td><td><p>에러를 발생시킬 에러 코드의 번호이다.</p><p>에러 코드에 대한 자세한
                  내용은 "<span>Tibero</span> 에러 참조 안내서"를
                  참고한다.</p></td></tr></tbody></table>
          </div>
        </li><li>
          <p>예제</p>

          <pre class="programlisting">/* ExtProcContext *epc */
SQLExtProcRaiseError(epc, 5070);</pre>
        </li></ul></div>
    </div>

    <div class="section" lang="ko"><div class="titlepage"><div><div><h3 class="title"><a id="sect_SQLExtProcRaiseErrorWithMsg"/>5.3.3. SQLExtProcRaiseErrorWithMsg 함수<a id="d5e1194" class="indexterm"/><a id="d5e1196" class="indexterm"/></h3></div></div></div>
      

      <p><code class="function">SQLExtProcRaiseError</code> 함수와 같이 에러를 발생시키는 함수이다.
      또한 사용자가 정의한 에러도 발생시킬 수 있다.</p>

      <div class="literallayout"><p/></div>

      <p><code class="function">SQLExtProcRaiseErrorWithMsg</code> 함수의 세부 내용은 다음과
      같다.</p>

      <div class="itemizedlist"><ul type="disc" compact="compact"><li>
          <p>문법</p>

          <pre class="programlisting">void SQLExtProcRaiseErrorWithMsg(ExtProcContext *, int errcode, char *errmsg);</pre>
        </li><li>
          <p>파라미터</p>

          <div class="informaltable">
            <table border="1"><colgroup><col width="150" align="left"/><col/></colgroup><thead><tr><th align="left">파라미터</th><th>설명</th></tr></thead><tbody><tr><td align="left">ExtProcContext *</td><td>ExtProcContext 구조체의 포인터이다.</td></tr><tr><td align="left">errcode</td><td>사용자가 정의한 에러 코드(20000 ~ 20999)이다.</td></tr><tr><td align="left">*errmsg</td><td>사용자가 정의한 에러 메시지이다.</td></tr></tbody></table>
          </div>
        </li><li>
          <p>예제</p>

          <pre class="programlisting">/* ExtProcContext *epc */
SQLExtProcRaiseErrorWithMsg(epc, 20100, "User exit procedure");</pre>
        </li></ul></div>
    </div>
  </div>
</div><div class="navfooter"><hr/><table width="100%" summary="Navigation footer"><tr><td width="40%" align="left"><a accesskey="p" href="sect_extproc_using.html">이전</a> </td><td width="20%" align="center"> </td><td width="40%" align="right"> <a accesskey="n" href="chapter_java_extproc.html">다음</a></td></tr><tr><td width="40%" align="left" valign="top">제4장 C External Procedure 사용 </td><td width="20%" align="center"><a accesskey="h" href="index.html">처음으로</a></td><td width="40%" align="right" valign="top"> 제6장 Java External Procedure</td></tr></table></div><div xmlns="" align="center"/></body></html>